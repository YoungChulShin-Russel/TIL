# MSA 전환과 운영에 대한 팁
## 사전 준비 사항
구성원들의 동의
- msa로 전환되는 시점에 대한 동의가 필요하다
- 시점에 대한 예시
   - 큰 code base로 인해서 신규 기능을 추가하는거에 대한 부담이 생길 때
   - 서비스의 성장을 시스템이 커버하지 못할 때

__회사 전체 도메인 그려보기__
- 그림을 바탕으로 무엇을 먼저 msa로 전환할지 정해보자
- 29cm에서는 가장 impact 있는 사용자(회원), 커머스(주문, 결제) domain을 먼저 분리

API 응답체계 통일
- 전체 서비스 내에서 일관된 응답체계를 가져간다

## 과정
monolitic에서 msa를 분리하는 과정
1. 신규 msa 서비스를 개발
2. 기존 서비스에서 신규 서비스로 routing하는 기능을 추가하고, 비율을 9:1로 조정한다
   - alb로 분리할 수 있어도 좋을 것 같다. 
3. 비율을 0:10까지로 계속 올린다
4. 2-3주 정도가 지나면 기존 서비스에서 신규 서비스의 기능을 삭제한다

DB를 전환
1. shared db pattern을 이용해서 기존 db에서 신규 db로 지속적 동기화를 시킨다. (예: 배치 프로그램 이용)
   - 이때 read traffic은 기존 db가 모두 가져간다
2. dual write를 이용해서 1개의 요청에 대해서 2개의 db에 동시에 기록한다
   - 기존 동기화 기능은 제거
   - 2개 db에 쓰는 작업은 1개의 transaction에서 동작한다
3. dual write를 신규 서비스의 single write로 전환한다

metric 기반의 monitoring을 통해서 상용 배포 또는 상용 테스트 이후에 장애를 파악할 수 있게 한다. 

서버간 통신 매커니즘 정의
- http
- message broker
   - 예: 결제 완료 -> message broker <- n개의 구독 서비스
- gRPC
   - 바이너리로 속도가 빠르다
   - 핵심 서비스에 적용하면 성능 항샹을 기대할 수 있다